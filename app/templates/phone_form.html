{% extends "base.html" %}
{% block content %}
{% set editing = request.args.get('edit') %}
{% if editing %}
  {% set phone = (phones|selectattr('id','equalto',editing|int)|list).0 %}
{% endif %}
<h3>{{ 'Edit Phone' if phone else 'Add Phone' }}</h3>
<form id="f" method="post" action="{{ '/phones/create' if not phone else ('/phones/%s/update' % phone.id) }}">
  <label>Brand</label><input name="brand" required value="{{ phone.brand if phone else '' }}">
  <label>Model</label><input name="model" required value="{{ phone.model if phone else '' }}">
  <label>Storage</label><input name="storage" value="{{ phone.storage if phone else '' }}">
  <label>Color</label><input name="color" value="{{ phone.color if phone else '' }}">
  <label>Condition</label>
  <select name="condition">
    {% for c in ['New','Good','Scrap'] %}
      <option {{ 'selected' if phone and phone.condition==c else '' }}>{{c}}</option>
    {% endfor %}
  </select>
  <label>Base Price</label><input name="base_price" type="number" step="0.01" required value="{{ phone.base_price if phone else '' }}">
  <label>Stock Qty</label><input name="stock_qty" type="number" required value="{{ phone.stock_qty if phone else 0 }}">
  <label>Tags</label><input name="tags" value="{{ phone.tags if phone else '' }}">
  <label>Discontinued</label>
  <select name="discontinued">
    <option value="false" {{ '' if (phone and phone.discontinued) else 'selected' }}>No</option>
    <option value="true"  {{ 'selected' if (phone and phone.discontinued) else '' }}>Yes</option>
  </select>
  <div style="margin-top:8px;">
    <button type="submit">Save</button>
  </div>
</form>
<script>
document.getElementById('f').addEventListener('submit', (e)=>{
  const key = localStorage.getItem('API_KEY') || prompt('Enter API key (default demo-api-key):','demo-api-key');
  localStorage.setItem('API_KEY', key);
  const form = e.target;
  e.preventDefault();
  const data = new FormData(form);
  fetch(form.action, {
    method: 'POST',
    headers: {'X-API-KEY': key},
    body: data
  }).then(r=> {
    if(r.redirected){ window.location = r.url; return; }
    return r.json().then(j=>{
      if(j.ok || j.id){ window.location='/'; } else { alert(JSON.stringify(j)); }
    })
  });
});
</script>
{% endblock %}
